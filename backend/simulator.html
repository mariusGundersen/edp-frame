<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Simulator</title>
  </head>
  <body>
    <canvas width="800" height="480"></canvas>
    <script type="module">
      const response = await fetch("./data/quad");

      const data = decompress(
        new Int8Array(await response.arrayBuffer()),
        96_000
      );

      function decompress(input, size) {
        const output = new Uint8Array(size);
        let o = 0;
        let i = 256;
        while (o < size) {
          if (input[i] < 0) {
            const repeats = 1 - input[i++];
            output.fill(input[i], o, o + repeats);
            o += repeats;
            i++;
          } else if (input[i] >= 64) {
            const index = input[i] - 64;
            output.set(input.slice(index * 4, index * 4 + 4), o);
            o += 4;
            i++;
          } else {
            const actuals = 1 + input[i++];
            output.set(input.slice(i, i + actuals), o);
            i += actuals;
            o += actuals;
          }
        }

        return output;
      }

      const canvas = document.querySelector("canvas");
      const ctx = canvas.getContext("2d");
      const imgData = ctx.getImageData(0, 0, 800, 480);

      const pixels = new Uint32Array(imgData.data.buffer);

      console.log(800 * 480, pixels.length, data.length);

      for (let i = 0; i < 800 * 480; i++) {
        pixels[800 * 480 - i] =
          (data[Math.floor(i / 8)] >> (7 - (i % 8))) & (1 == 1)
            ? 0xff_ff_ff_ff
            : 0xff_00_00_00;
      }
      for (let i = 0; i < 800 * 480; i++) {
        pixels[800 * 480 - i] =
          (data[Math.floor(480 * 100 + i / 8)] >> (7 - (i % 8))) & (1 === 1)
            ? 0xff_00_00_ff
            : pixels[800 * 480 - i];
      }

      ctx.putImageData(imgData, 0, 0);
    </script>
  </body>
</html>
